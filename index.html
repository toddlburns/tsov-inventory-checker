<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Low Inventory Checker</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><radialGradient id='g' cx='50%25' cy='50%25' r='50%25'><stop offset='0%25' stop-color='%23fff' stop-opacity='0.9'/><stop offset='30%25' stop-color='%23ff69b4'/><stop offset='70%25' stop-color='%23cc0066'/><stop offset='100%25' stop-color='%23cc0066' stop-opacity='0'/></radialGradient><radialGradient id='glow' cx='50%25' cy='50%25' r='50%25'><stop offset='60%25' stop-color='%23ff69b4' stop-opacity='0.4'/><stop offset='100%25' stop-color='%23ff69b4' stop-opacity='0'/></radialGradient></defs><circle cx='50' cy='50' r='48' fill='url(%23glow)'/><circle cx='50' cy='50' r='30' fill='url(%23g)'/></svg>">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f0f;
      color: #e0e0e0;
      min-height: 100vh;
    }

    /* Password Gate */
    #gate {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    #gate h1 { font-size: 1.4rem; margin-bottom: 8px; color: #fff; }
    #gate p { font-size: 0.85rem; color: #888; margin-bottom: 24px; }
    #gate .input-row { display: flex; gap: 8px; }

    #gate input {
      padding: 10px 16px; font-size: 1rem; border: 1px solid #333;
      border-radius: 6px; background: #1a1a1a; color: #fff;
      outline: none; width: 260px;
    }
    #gate input:focus { border-color: #555; }

    #gate button {
      padding: 10px 20px; font-size: 1rem; border: none; border-radius: 6px;
      background: #fff; color: #000; cursor: pointer; font-weight: 600;
    }
    #gate button:hover { background: #ddd; }
    #gate .error { color: #e54; font-size: 0.85rem; margin-top: 12px; min-height: 20px; }

    /* App */
    #app {
      display: none;
      max-width: 600px;
      margin: 0 auto;
      padding: 40px 20px 100px;
    }

    #app h1 { font-size: 1.5rem; color: #fff; margin-bottom: 4px; }
    #app .subtitle { font-size: 0.8rem; color: #666; margin-bottom: 24px; }

    #url-input {
      width: 100%; padding: 14px 18px; font-size: 0.9rem;
      font-family: monospace;
      border: 1px solid #333; border-radius: 8px; background: #1a1a1a;
      color: #fff; outline: none; transition: border-color 0.2s;
      resize: vertical; min-height: 44px; height: 44px;
      line-height: 1.5;
    }
    #url-input:focus { border-color: #555; height: auto; min-height: 120px; }
    #url-input::placeholder { color: #555; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

    #check-btn {
      margin-top: 12px; width: 100%; padding: 12px; font-size: 1rem;
      font-weight: 600; border: none; border-radius: 6px; cursor: pointer;
      background: #cc0066; color: #fff; transition: background 0.15s;
    }
    #check-btn:hover { background: #aa0055; }
    #check-btn:disabled { background: #333; color: #666; cursor: not-allowed; }

    #status {
      font-size: 0.8rem; color: #666; margin-top: 12px; min-height: 20px;
    }

    /* Results */
    #results {
      margin-top: 20px; display: none;
      flex-direction: column; gap: 8px;
    }

    .result-card {
      padding: 16px; border-radius: 8px; border: 1px solid #333;
      background: #1a1a1a;
    }

    .result-card.found {
      border-color: #2a8a4a;
      background: rgba(42, 138, 74, 0.1);
    }

    .result-card.not-found {
      border-color: #3a7bd5;
      background: rgba(58, 123, 213, 0.08);
    }

    .result-indicator {
      font-size: 1.1rem; font-weight: 700; margin-bottom: 8px;
    }

    .result-indicator.found { color: #4eca7a; }
    .result-indicator.not-found { color: #5b9bf5; }

    .result-encouragement {
      font-size: 0.85rem; color: #8bb8ff; margin-top: 8px;
      font-style: italic;
    }

    .result-handle {
      font-family: monospace; font-size: 0.85rem; color: #888;
      margin-bottom: 4px; word-break: break-all;
    }

    .result-title {
      font-size: 1rem; color: #fff; margin-bottom: 8px;
    }

    .result-link {
      font-size: 0.85rem;
    }

    .result-link a {
      color: #cc0066; text-decoration: none;
    }
    .result-link a:hover { text-decoration: underline; }

    /* Collection status bar */
    #collection-status {
      margin-bottom: 20px; padding: 14px 16px; border-radius: 8px;
      border: 1px solid #333; background: #1a1a1a; display: none;
    }
    #collection-status.visible { display: block; }
    #collection-status .cs-row {
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    #collection-status .cs-msg {
      display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #ccc;
      flex: 1; min-width: 0;
    }
    #collection-status .cs-progress-wrap {
      width: 100%; height: 4px; background: #333; border-radius: 2px;
      margin-top: 10px; overflow: hidden;
    }
    #collection-status .cs-progress-bar {
      height: 100%; background: #cc0066; border-radius: 2px;
      transition: width 0.3s ease; width: 0%;
    }
    #collection-status.error { border-color: #663; }
    #collection-status.error .cs-msg { color: #e54; }
    #collection-status.success { border-color: #2a8a4a; }
    #collection-status.success .cs-msg { color: #4eca7a; }
    #collection-status .cs-retry {
      background: none; border: 1px solid #555; color: #ccc; padding: 6px 14px;
      border-radius: 5px; font-size: 0.8rem; cursor: pointer; white-space: nowrap;
    }
    #collection-status .cs-retry:hover { border-color: #888; color: #fff; }

    /* Collection info */
    #collection-info {
      margin-top: 16px; font-size: 0.75rem; color: #444;
    }

    #logout-btn {
      position: fixed; top: 16px; right: 16px; background: none;
      border: 1px solid #333; color: #666; padding: 6px 12px;
      border-radius: 4px; font-size: 0.75rem; cursor: pointer;
    }
    #logout-btn:hover { color: #aaa; border-color: #555; }

    #refresh-btn {
      background: none; border: 1px solid #333; color: #666;
      padding: 4px 10px; border-radius: 4px; font-size: 0.7rem;
      cursor: pointer; margin-left: 8px;
    }
    #refresh-btn:hover { color: #aaa; border-color: #555; }

    .loading-spinner {
      display: inline-block; width: 14px; height: 14px;
      border: 2px solid #333; border-top-color: #cc0066;
      border-radius: 50%; animation: spin 0.8s linear infinite;
      vertical-align: middle; margin-right: 6px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- Password Gate -->
  <div id="gate">
    <h1 id="gate-title">Enter Password</h1>
    <p id="gate-subtitle">Access is restricted.</p>
    <div class="input-row">
      <input type="password" id="pw-input" placeholder="Password" autocomplete="off">
      <button id="pw-btn" onclick="handlePassword()">Go</button>
    </div>
    <div class="error" id="pw-error"></div>
  </div>

  <!-- Main App -->
  <div id="app">
    <h1>Low Inventory Checker</h1>
    <p class="subtitle">Paste up to 20 product URLs (one per line) to check against the low-inventory collection.</p>
    <div id="collection-status"></div>
    <textarea id="url-input" placeholder="https://thesoundofvinyl.us/products/some-album" rows="1" autofocus></textarea>
    <button id="check-btn" onclick="checkProducts()">Check</button>
    <div id="status"></div>
    <div id="results"></div>
    <div id="collection-info"></div>
    <button id="logout-btn" onclick="logout()">Lock</button>
  </div>

  <script>
    // ─── Password Protection ───────────────────────────────────────────
    async function sha256(str) {
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    const STORAGE_KEY = 'tsov_pw_hash';
    function getStoredHash() { return localStorage.getItem(STORAGE_KEY); }

    async function handlePassword() {
      const input = document.getElementById('pw-input').value;
      if (!input) return;
      const hash = await sha256(input);
      const stored = getStoredHash();
      if (!stored) {
        localStorage.setItem(STORAGE_KEY, hash);
        sessionStorage.setItem('tsov_auth', 'true');
        showApp();
      } else if (hash === stored) {
        sessionStorage.setItem('tsov_auth', 'true');
        showApp();
      } else {
        document.getElementById('pw-error').textContent = 'Incorrect password.';
        document.getElementById('pw-input').value = '';
        document.getElementById('pw-input').focus();
      }
    }

    function showApp() {
      document.getElementById('gate').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('url-input').focus();
      loadCollection();
    }

    function showGate() {
      document.getElementById('gate').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
      const stored = getStoredHash();
      if (!stored) {
        document.getElementById('gate-title').textContent = 'Create a Password';
        document.getElementById('gate-subtitle').textContent = 'Set a password for this tool. Share it with your team.';
        document.getElementById('pw-btn').textContent = 'Set';
      } else {
        document.getElementById('gate-title').textContent = 'Enter Password';
        document.getElementById('gate-subtitle').textContent = 'Access is restricted.';
        document.getElementById('pw-btn').textContent = 'Go';
      }
    }

    function logout() {
      sessionStorage.removeItem('tsov_auth');
      document.getElementById('pw-input').value = '';
      document.getElementById('pw-error').textContent = '';
      document.getElementById('url-input').value = '';
      document.getElementById('results').style.display = 'none';
      document.getElementById('status').textContent = '';
      document.getElementById('collection-info').textContent = '';
      showGate();
    }

    document.getElementById('pw-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') handlePassword();
    });

    if (sessionStorage.getItem('tsov_auth') === 'true' && getStoredHash()) {
      showApp();
    } else {
      showGate();
    }

    // ─── Collection Loading ────────────────────────────────────────────
    const SHOP = 'https://thesoundofvinyl.us';
    const COLLECTION_HANDLE = 'low-inventory';

    let collectionProducts = null; // Map of handle -> product
    let collectionLoading = false;

    function setCollectionStatus(state, msg, progress) {
      const el = document.getElementById('collection-status');
      el.className = state === 'hidden' ? '' : 'visible' + (state === 'error' ? ' error' : state === 'success' ? ' success' : '');
      if (state === 'hidden') return;

      const retryBtn = state === 'error'
        ? '<button class="cs-retry" onclick="loadCollection(true)">Retry</button>' : '';
      const progressBar = state === 'loading'
        ? `<div class="cs-progress-wrap"><div class="cs-progress-bar" style="width:${progress || 5}%"></div></div>` : '';
      const spinner = state === 'loading'
        ? '<span class="loading-spinner"></span>' : '';

      el.innerHTML = `<div class="cs-row"><div class="cs-msg">${spinner}${msg}</div>${retryBtn}</div>${progressBar}`;
    }

    async function loadCollection(forceRefresh = false) {
      if (collectionProducts && !forceRefresh) {
        updateCollectionInfo();
        return;
      }
      if (collectionLoading) return;

      collectionLoading = true;
      const btn = document.getElementById('check-btn');
      btn.disabled = true;
      document.getElementById('status').textContent = '';
      setCollectionStatus('loading', 'Connecting to collection&hellip;', 5);

      try {
        const products = new Map();
        let page = 1;
        const limit = 250;

        while (true) {
          setCollectionStatus('loading',
            page === 1
              ? 'Scanning low-inventory collection&hellip;'
              : `Scanning page ${page}&hellip; ${products.size} products found`,
            Math.min(90, 10 + page * 20));

          const url = `${SHOP}/collections/${COLLECTION_HANDLE}/products.json?limit=${limit}&page=${page}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();

          if (!data.products || data.products.length === 0) break;

          for (const p of data.products) {
            products.set(p.handle.toLowerCase(), {
              title: p.title,
              handle: p.handle,
              url: `${SHOP}/products/${p.handle}`
            });
          }

          setCollectionStatus('loading', `${products.size} products loaded`, Math.min(95, 10 + page * 20));

          if (data.products.length < limit) break;
          page++;
        }

        collectionProducts = products;
        btn.disabled = false;
        setCollectionStatus('success', `${products.size} products loaded from <code>${COLLECTION_HANDLE}</code> collection`);
        setTimeout(() => {
          if (collectionProducts) setCollectionStatus('hidden');
        }, 3000);
        updateCollectionInfo();
      } catch (err) {
        setCollectionStatus('error', `Failed to load collection: ${err.message}`);
        btn.disabled = false;
      } finally {
        collectionLoading = false;
      }
    }

    function updateCollectionInfo() {
      const info = document.getElementById('collection-info');
      if (collectionProducts) {
        const refreshBtn = '<button id="refresh-btn" onclick="loadCollection(true)">Refresh</button>';
        info.innerHTML = `${collectionProducts.size} products cached from <code>${COLLECTION_HANDLE}</code> collection. ${refreshBtn}`;
      }
    }

    // ─── URL Normalization ─────────────────────────────────────────────
    function extractHandle(input) {
      let cleaned = input.trim();
      if (!cleaned) return '';

      // Remove hash fragment
      cleaned = cleaned.split('#')[0];
      // Remove query params
      cleaned = cleaned.split('?')[0];
      // Remove trailing slash
      cleaned = cleaned.replace(/\/+$/, '');

      // Try to extract from /products/{handle}
      const match = cleaned.match(/\/products\/([^/?#]+)/);
      if (match) {
        return match[1].toLowerCase();
      }

      // If no /products/ path, treat as bare handle
      // Strip any remaining URL parts (in case someone pastes a full URL without /products/)
      const lastSegment = cleaned.split('/').pop();
      return lastSegment.toLowerCase();
    }

    // ─── Encouragement Messages ────────────────────────────────────────
    const ALL_CLEAR_MESSAGES = [
      "Stock is looking healthy — promote away!",
      "Plenty of copies to go around. Blast it everywhere!",
      "Green light — shout it from the rooftops!",
      "Full steam ahead — this one's well-stocked!",
      "No inventory worries here. Push it hard!",
      "The shelves are full — time to sell some records!",
      "Stock levels looking cozy. Go wild with the promo!",
      "All clear! Post it, share it, shout about it!",
      "Inventory is chillin'. Promote to your heart's content!",
      "No shortage here — let the marketing machine roll!",
      "This one's stacked up nicely. Feature it everywhere!",
      "Warehouse says: we've got plenty. Go for it!",
      "Supply is strong — unleash the campaigns!",
      "Nothing to worry about — promote like there's no tomorrow!",
      "Inventory vibes: immaculate. Send those emails!",
      "Stock check: thriving. Time to make some noise!",
      "This title is sitting pretty — spread the word!",
      "We're loaded up on this one. Market it like crazy!",
      "Smooth sailing on inventory. Promote with confidence!",
      "No red flags here — this one's ready for the spotlight!",
    ];

    function getRandomEncouragement() {
      return ALL_CLEAR_MESSAGES[Math.floor(Math.random() * ALL_CLEAR_MESSAGES.length)];
    }

    // ─── Product Check ─────────────────────────────────────────────────
    const MAX_URLS = 20;

    function checkProducts() {
      const raw = document.getElementById('url-input').value.trim();
      const resultsDiv = document.getElementById('results');

      if (!raw) {
        resultsDiv.style.display = 'none';
        return;
      }

      if (!collectionProducts) {
        document.getElementById('status').textContent = 'Collection not loaded yet. Please wait...';
        return;
      }

      // Split by newlines, filter empties
      const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);
      if (lines.length === 0) {
        resultsDiv.style.display = 'none';
        return;
      }

      if (lines.length > MAX_URLS) {
        document.getElementById('status').textContent = `Please enter no more than ${MAX_URLS} URLs at a time.`;
        return;
      }

      document.getElementById('status').textContent = '';

      let foundCount = 0;
      const cards = lines.map(line => {
        const handle = extractHandle(line);
        if (!handle) {
          return `<div class="result-card not-found">
            <div class="result-indicator not-found">Could not parse</div>
            <div class="result-handle">${escapeHtml(line)}</div>
          </div>`;
        }

        const product = collectionProducts.get(handle);
        if (product) {
          foundCount++;
          return `<div class="result-card found">
            <div class="result-indicator found">Low inventory</div>
            <div class="result-handle">${escapeHtml(handle)}</div>
            <div class="result-title">${escapeHtml(product.title)}</div>
            <div class="result-link"><a href="${escapeHtml(product.url)}" target="_blank" rel="noopener">${escapeHtml(product.url)}</a></div>
          </div>`;
        } else {
          return `<div class="result-card not-found">
            <div class="result-indicator not-found">Not low inventory</div>
            <div class="result-handle">${escapeHtml(handle)}</div>
            <div class="result-encouragement">${escapeHtml(getRandomEncouragement())}</div>
          </div>`;
        }
      });

      document.getElementById('status').textContent =
        `${lines.length} checked — ${foundCount} in low inventory, ${lines.length - foundCount} clear`;

      resultsDiv.innerHTML = cards.join('');
      resultsDiv.style.display = 'flex';
    }

    // Ctrl/Cmd+Enter to check from textarea
    document.getElementById('url-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) checkProducts();
    });

    // ─── Utility ───────────────────────────────────────────────────────
    function escapeHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }
  </script>
</body>
</html>
